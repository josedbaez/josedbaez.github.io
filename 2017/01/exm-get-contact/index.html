<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />

    

    
    <title>EXM - Get xDb contact | José Domínguez</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="keywords" content="exm,xdb" />
    
    <meta name="description" content="How to retrieve xDb contacts data to use in EXM newsletter. When generating an EXM newsletter you might need to get contacts’ details so you can personalise the newsletter further…">
<meta name="keywords" content="exm,xdb">
<meta property="og:type" content="article">
<meta property="og:title" content="EXM - Get xDb contact">
<meta property="og:url" content="https://josedbaez.com/2017/01/exm-get-contact/index.html">
<meta property="og:site_name" content="José Domínguez">
<meta property="og:description" content="How to retrieve xDb contacts data to use in EXM newsletter. When generating an EXM newsletter you might need to get contacts’ details so you can personalise the newsletter further…">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://josedbaez.com/images/contact.jpg">
<meta property="og:updated_time" content="2019-11-17T18:10:22.668Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="EXM - Get xDb contact">
<meta name="twitter:description" content="How to retrieve xDb contacts data to use in EXM newsletter. When generating an EXM newsletter you might need to get contacts’ details so you can personalise the newsletter further…">
<meta name="twitter:image" content="https://josedbaez.com/images/contact.jpg">
    

    
        <link rel="alternate" href="/atom.xml" title="José Domínguez" type="application/atom+xml" />
    

    
        <link rel="icon" href="/images/favicon.ico" />
    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/titillium-web/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/3.3.1/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
    
        <script type="text/javascript">
(function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-83689815-1', 'auto');
ga('send', 'pageview');

</script>
    
    


</head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                        <h2 class="subtitle-wrap">
                            <p class="subtitle">C#, .net, sitecore &amp; some other stuff</p>
                        </h2>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">Home</a>
                                </li>
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/about/index.html">About</a>
                                </li>
                            
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="https://josedbaez.com"></form>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner article">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/Sitecore/">Sitecore</a><i class="icon fa fa-angle-right"></i><a class="page-title-link" href="/categories/Sitecore/EXM/">EXM</a>
    </h1>
</div>

                        <div class="main-body-content">
                            <article id="post-exm-get-contact" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        EXM - Get xDb contact
        </h1>
    

            </header>
        
        
            <div class="article-meta">
                
    <div class="article-date">
        <a href="/2017/01/exm-get-contact/" class="article-date">
            <time datetime="2017-01-18T00:00:00.000Z" itemprop="datePublished">2017-01-18</time>
        </a>
    </div>

		

                
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/exm/">exm</a>, <a class="tag-link" href="/tags/xdb/">xdb</a>
    </div>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <h2 id=""><a href="#" class="headerlink" title=""></a><img class="hero-img" src="/images/contact.jpg" alt="Contact"></h2><p>How to retrieve xDb contacts data to use in EXM newsletter. When generating an EXM newsletter you might need to get contacts’ details so you can personalise the newsletter further…<br><a id="more"></a></p>
<p><em>Versions used: Sitecore 8.1 rev. 151207 (Update-1). EXM 3.2.0 rev. 151020</em></p>
<p><strong>Update:</strong> Code updated to use tracker contact when delivering emails.</p>
<p>When generating an EXM newsletter you might need to get contacts’ details so you can personalise the newsletter further than just OOTB token replacement. For example, render different datasource depending on a contact’s preference.</p>
<p>This post outlines how to get a contact’s ID and the contact’s object from xDB so you can read its data.</p>
<p>The following function retrieves the contact guid in all 3 EXM tabs where the contact is read: message, review and delivery. There are other ways of retrieving this (e.g. querystring) but the following works in every scenario and was recommended by an EXM developer at sitecore (sorry can’t remember who it was but thank you!). <strong>Do not forget to see the extension class required at the bottom</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Guid <span class="title">GetContactId</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> contactGuid = Guid.Empty;</span><br><span class="line">    <span class="keyword">var</span> recipientId = <span class="keyword">string</span>.Empty;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//get recipient ID</span></span><br><span class="line">    <span class="keyword">var</span> recipientIdObj = System.Web.HttpContext.Current.GetRecipientId();</span><br><span class="line">    <span class="keyword">if</span> (recipientIdObj != <span class="literal">null</span>)</span><br><span class="line">        recipientId = recipientIdObj.ToString();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(recipientId))</span><br><span class="line">    &#123;</span><br><span class="line">        recipientId = recipientId.Replace(<span class="string">"xdb:"</span>, <span class="keyword">string</span>.Empty);</span><br><span class="line">        ShortID shortRecipientId;</span><br><span class="line">        <span class="keyword">if</span> (ShortID.TryParse(recipientId, <span class="keyword">out</span> shortRecipientId))</span><br><span class="line">            contactGuid = shortRecipientId.Guid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> contactGuid != Guid.Empty ? contactGuid : Guid.Empty;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The function first gets the ID using sitecore’s extension inside <code>Sitecore.Modules.EmailCampaign.Core.Extensions</code> and then converts it to GUID.</p>
<p>After you have the contact ID, you can retrieve the xDB contact like this:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> Sitecore.Analytics.Tracking.Contact currentContact = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//get contact from tracker (when delivering emails)</span></span><br><span class="line"><span class="keyword">if</span>(Sitecore.Analytics.Tracker.Current != <span class="literal">null</span> &amp;&amp; Sitecore.Analytics.Tracker.Current.Contact!=<span class="literal">null</span>)</span><br><span class="line">    currentContact = Sitecore.Analytics.Tracker.Current.Contact;</span><br><span class="line"><span class="keyword">else</span>&#123; <span class="comment">//this will catch test email and preview tabs</span></span><br><span class="line">    <span class="keyword">var</span> contactRepo = Sitecore.Configuration.Factory.CreateObject(<span class="string">"contactRepository"</span>, <span class="literal">true</span>) <span class="keyword">as</span> Sitecore.Analytics.Data.ContactRepository;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (contactRepo == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> leaseOwner = <span class="keyword">new</span> LeaseOwner(<span class="string">"admin"</span>, LeaseOwnerType.OutOfRequestWorker);</span><br><span class="line">    <span class="keyword">var</span> xContactid = <span class="keyword">new</span> XdbContactId(contactGuid);</span><br><span class="line"></span><br><span class="line">    currentContact = contactRepo.TryLoadContact(xContactid.Value.Guid, leaseOwner, TimeSpan.FromMinutes(<span class="number">1</span>)).Object;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//facets</span></span><br><span class="line">    <span class="keyword">var</span> facets = currentContact.Facets;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>Please let me know what you think and/or if you can spot any errors.<br><em>/eom</em></p>

        </div>
        <footer class="article-footer">
            



    <a data-url="https://josedbaez.com/2017/01/exm-get-contact/" data-id="ck6ce19uc0007mi99cpt0le2g" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>



                        </div>
                    </section>
                    
                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <!--
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                -->
                <p>&copy; 2020 José Domínguez</p>
                <p>Opinions expressed on this blog are my own, and not necessarily those of my employer.</p>
            </div>
            <div class="footer-plugins">
              
    


            </div>
        </div>
    </div>
</footer>

        
    
    <script>
    var disqus_shortname = 'josedbaez';
    
    
    var disqus_url = 'https://josedbaez.com/2017/01/exm-get-contact/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>
