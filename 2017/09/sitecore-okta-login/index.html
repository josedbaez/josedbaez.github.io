<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />

    

    
    <title>Log in to Sitecore using OpenID Connect with Okta | José Domínguez</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="keywords" content="openid,okta,authentication,sso" />
    
    <meta name="description" content="How to implement OpenID Connect Single Sign-On with Okta to log in to sitecore (backend NOT client facing site) by intercepting Authorize attribute.">
<meta name="keywords" content="openid,okta,authentication,sso">
<meta property="og:type" content="article">
<meta property="og:title" content="Log in to Sitecore using OpenID Connect with Okta">
<meta property="og:url" content="https://josedbaez.com/2017/09/sitecore-okta-login/index.html">
<meta property="og:site_name" content="José Domínguez">
<meta property="og:description" content="How to implement OpenID Connect Single Sign-On with Okta to log in to sitecore (backend NOT client facing site) by intercepting Authorize attribute.">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://josedbaez.com/images/okta-sso.png">
<meta property="og:updated_time" content="2019-04-13T23:49:02.228Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Log in to Sitecore using OpenID Connect with Okta">
<meta name="twitter:description" content="How to implement OpenID Connect Single Sign-On with Okta to log in to sitecore (backend NOT client facing site) by intercepting Authorize attribute.">
<meta name="twitter:image" content="https://josedbaez.com/images/okta-sso.png">
    

    
        <link rel="alternate" href="/atom.xml" title="José Domínguez" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/titillium-web/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/3.3.1/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
    
        <script type="text/javascript">
(function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-83689815-1', 'auto');
ga('send', 'pageview');

</script>
    
    


</head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                        <h2 class="subtitle-wrap">
                            <p class="subtitle">C#, .net, sitecore &amp; some other stuff</p>
                        </h2>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">Home</a>
                                </li>
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/about/index.html">About</a>
                                </li>
                            
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="https://josedbaez.com"></form>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner article">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/Sitecore/">Sitecore</a><i class="icon fa fa-angle-right"></i><a class="page-title-link" href="/categories/Sitecore/Authentication/">Authentication</a>
    </h1>
</div>

                        <div class="main-body-content">
                            <article id="post-sitecore-okta-login" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        Log in to Sitecore using OpenID Connect with Okta
        </h1>
    

            </header>
        
        
            <div class="article-meta">
                
    <div class="article-date">
        <a href="/2017/09/sitecore-okta-login/" class="article-date">
            <time datetime="2017-09-30T00:00:00.000Z" itemprop="datePublished">2017-09-30</time>
        </a>
    </div>

		

                
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/authentication/">authentication</a>, <a class="tag-link" href="/tags/okta/">okta</a>, <a class="tag-link" href="/tags/openid/">openid</a>, <a class="tag-link" href="/tags/sso/">sso</a>
    </div>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <h2 id=""><a href="#" class="headerlink" title=""></a><img class="hero-img" src="/images/okta-sso.png" alt="Sitecore Okta SSO"></h2><p>How to implement OpenID Connect Single Sign-On with Okta to log in to sitecore (backend NOT client facing site) by intercepting Authorize attribute.<br><a id="more"></a></p>
<p><em>Versions used: Sitecore 8.2 rev. 170614 (8.2 Update-4).</em></p>
<p><em>Go <a href="/2018/03/sitecore9-sso/">here</a> for solution on sitecore 9</em></p>
<p><strong>Update/Warning:</strong> Preview mode fails for virtual users with the code below. To fix: 1- Call <a href="#ticket-function">this function</a> after authenticating the user to create an authentication ticket in sitecore. 2- Contact sitecore support and quote public reference 192715 so they can provide a known bug related to <code>item:preview</code> command.</p>
<p>In this post I will outline how to implement OpenID SSO with <a href="https://www.okta.com/" target="_blank" rel="noopener">Okta</a> to allow users to <strong>log in to sitecore (backend NOT client facing site)</strong> from Okta’s dashboard or by being redirected to Okta’s login screen when trying to directly access sitecore through custom url <sup><a href="#custom-url">custom url</a></sup>. <em>Authentication logic has been copied/modified from <a href="https://github.com/oktadeveloper/okta-oauth-aspnet-codeflow" target="_blank" rel="noopener">Okta’s github example code.</a></em></p>
<p>The solution provided by OKTA uses <a href="http://owin.org/" target="_blank" rel="noopener">OWIN</a> libraries. I integrated the OWIN middleware through a sitecore pipeline following <a href="https://github.com/VyacheslavPritykin/Sitecore-Owin" target="_blank" rel="noopener">VyacheslavPritykin Sitecore-Owin</a> solution.</p>
<p><strong> The code flow of this solution: </strong><br>The user requests a method decorated with <code>Authorize</code><sup><a href="#all-authorize">Authorize</a></sup> attribute, if the user is not authenticated, the middleware will get triggered and the user is redirected to Okta. Once the user logs in to okta, the middleware gets notified, we extract the information returned by okta and log the user in as a virtual user with <code>AuthenticationManager</code>. The original request (to method decorated with Authorize) is sent again and the user now goes through because it has been authenticated.</p>
<p><strong>The solution is divided in the following parts:</strong></p>
<ul>
<li>OKTA application configuration</li>
<li>Sitecore pipeline to register OWIN middleware</li>
<li>OWIN middleware to handle authentication redirects</li>
<li>Sitecore login helper</li>
<li>Login controller</li>
</ul>
<h2 id="OKTA-application-configuration"><a href="#OKTA-application-configuration" class="headerlink" title="OKTA application configuration"></a>OKTA application configuration</h2><p>You’ll need to <a href="https://developer.okta.com/docs/api/getting_started/api_test_client.html" target="_blank" rel="noopener">Sign up for Okta</a> and get access to the API.</p>
<p>Once you have access to okta; within the Admin part of your account, add a new application with the following selections: Web as platform and OpenID Connect as Sign on method.</p>
<p>Go to your newly created application and configure as follows:</p>
<p><strong>General tab</strong><br><img class="content-img" src="/images/okta-general-tab.jpg" alt="Okta general tab"></p>
<p>Most of the configuration is self explanatory. <code>Login redirect URIs</code> is defined by Okta as “URI where Okta will send OAuth responses”. We don’t really use it but it’s required because a request to it will be sent once the user has logged in to Okta. <code>Initiate login URI</code> is another request we will get from Okta once the user has logged in or when the user tries to access sitecore from Okta’s dashboard. This is where we will redirect the user to sitecore.</p>
<p>Copy <a name="client-id"><code>Client ID</code></a> and <a name="client-secret"><code>Client secret</code><a> as we are going to need these later.</a></a></p>
<p><strong>Sign On tab</strong><br><img class="content-img" src="/images/okta-sign-on-tab.jpg" alt="Okta sign-on tab"><br><img class="content-img" src="/images/okta-sign-on-policy.png" alt="Okta sign-on policy"></p>
<p>On this tab you can configure access policy and the OpenID token. We are telling okta to return all groups but here you can configure the groups claim to specify which groups you want included by entering expressions that will be used to filter groups. For example myapp.* means all groups prefixed with “myapp” will be included in the response attribute statement. <a href="https://support.okta.com/help/Documentation/Knowledge_Article/Configuring-Okta-Template-SAML-20-application" target="_blank" rel="noopener">Go here</a> for more information.</p>
<p><strong>Assignments</strong><br>Here you assign which users and or groups can access your app. I recommend using groups instead of users.</p>
<p>Okta groups are like sitecore roles; we will need to map these groups to equivalent sitecore roles to give them proper sitecore permissions. To make the mapping easier, we decided to name Okta groups the same as the Sitecore role it will be mapped to.</p>
<h2 id="Sitecore-OWIN-middleware-pipeline"><a href="#Sitecore-OWIN-middleware-pipeline" class="headerlink" title="Sitecore OWIN middleware pipeline"></a>Sitecore OWIN middleware pipeline</h2><p>You can either install <a href="https://github.com/VyacheslavPritykin/Sitecore-Owin" target="_blank" rel="noopener">VyacheslavPritykin Sitecore-Owin</a> nuget package or do the following.</p>
<ul>
<li><p>Define a custom pipeline in sitecore</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sitecore</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">pipelines</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">initOwinMiddleware</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">processor</span> <span class="attr">mode</span>=<span class="string">"on"</span> <span class="attr">type</span>=<span class="string">"MySite.OwinMiddleware, MySite"</span>&gt;</span><span class="tag">&lt;/<span class="name">processor</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">initOwinMiddleware</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">pipelines</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sitecore</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>The processor requires a custom <code>PipelineArgs</code> that sets the Owin app object on startup.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Sitecore.Pipelines;</span><br><span class="line"><span class="keyword">using</span> IAppBuilder = Owin.IAppBuilder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MySite</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">InitOwinMiddlewareMiddlewareArgs</span> : <span class="title">PipelineArgs</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> Owin.IAppBuilder App &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">InitializeOwinOktaMiddlewareArgs</span>(<span class="params">IAppBuilder app</span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.App = app;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>The <code>initOwinMiddleware</code> pipeline is called on startup by setting the <code>owin:AppStartup</code> class reference in our web.config.<br>The following transform:</p>
<ul>
<li>Adds settings <code>owin:AutomaticAppStartup</code> and <code>owin:AppStartup</code>.</li>
<li>Sets authentication to none. This is done to avoid an infinite loop from okta to sitecore.</li>
</ul>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">appSettings</span> <span class="attr">xdt:Transform</span>=<span class="string">"InsertIfMissing"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">add</span> <span class="attr">key</span>=<span class="string">"owin:AutomaticAppStartup"</span> <span class="attr">value</span>=<span class="string">"true"</span> <span class="attr">xdt:Transform</span>=<span class="string">"InsertIfMissing"</span> <span class="attr">xdt:Locator</span>=<span class="string">"Match(key)"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">add</span> <span class="attr">key</span>=<span class="string">"owin:AppStartup"</span> <span class="attr">value</span>=<span class="string">"MySite.Startup, MySite"</span> <span class="attr">xdt:Transform</span>=<span class="string">"InsertIfMissing"</span> <span class="attr">xdt:Locator</span>=<span class="string">"Match(key)"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">appSettings</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">system.web</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">authentication</span> <span class="attr">mode</span>=<span class="string">"None"</span> <span class="attr">xdt:Transform</span>=<span class="string">"SetAttributes"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">authentication</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">system.web</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Startup class implementation.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.Owin;</span><br><span class="line"><span class="keyword">using</span> Owin;</span><br><span class="line"><span class="keyword">using</span> Sitecore.Pipelines;</span><br><span class="line"></span><br><span class="line">[<span class="meta">assembly: OwinStartup(typeof(Startup))</span>]</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MySite</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Startup</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Configuration</span>(<span class="params">IAppBuilder app</span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            CorePipeline.Run(<span class="string">"initOwinMiddleware"</span>, <span class="keyword">new</span> InitOwinMiddlewareMiddlewareArgs(app));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="OWIN-middleware-and-Okta-redirect-implementation"><a href="#OWIN-middleware-and-Okta-redirect-implementation" class="headerlink" title="OWIN middleware and Okta redirect implementation"></a>OWIN middleware and Okta redirect implementation</h2><p>The OWIN middleware pipeline handles the authentication configuration of the web application. It tells asp.net where to redirect the user and what to do when the authorisation is given to the user.</p>
<p>As stated before, this logic was extracted from <a href="https://github.com/oktadeveloper/okta-oauth-aspnet-codeflow" target="_blank" rel="noopener">Okta’s codeflow example code.</a> and modified so it can work with latest OWIN and Claims libraries <sup><a href="#versions">versions used</a></sup>.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Globalization;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Security.Claims;</span><br><span class="line"><span class="keyword">using</span> IdentityModel.Client;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Owin.Security;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Owin.Security.Cookies;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Owin.Security.OpenIdConnect;</span><br><span class="line"><span class="keyword">using</span> Owin;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MySite</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">OwinMiddleware</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Process</span>(<span class="params">InitOwinMiddlewareMiddlewareArgs args</span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> oathAuthority = <span class="string">"https://dev-666666.oktapreview.com"</span>; <span class="comment">//change this</span></span><br><span class="line">            args.App.UseCookieAuthentication(<span class="keyword">new</span> CookieAuthenticationOptions &#123;AuthenticationType = <span class="string">"Cookies"</span>&#125;);</span><br><span class="line">            args.App.UseOpenIdConnectAuthentication(<span class="keyword">new</span> OpenIdConnectAuthenticationOptions</span><br><span class="line">            &#123;</span><br><span class="line">                ClientId = <span class="string">"myclientid123"</span>, <span class="comment">//change this</span></span><br><span class="line">                Authority = oathAuthority,</span><br><span class="line">                RedirectUri = <span class="string">"https://Website_URL/Okta/Callback"</span>, <span class="comment">//change this</span></span><br><span class="line">                ResponseType = <span class="string">"code id_token"</span>, <span class="comment">//</span></span><br><span class="line">                Scope = <span class="string">"openid email profile address phone groups offline_access"</span>, <span class="comment">//claims to get from okta</span></span><br><span class="line">                SignInAsAuthenticationType = <span class="string">"Cookies"</span>,</span><br><span class="line">                UseTokenLifetime = <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">                Notifications = <span class="keyword">new</span> OpenIdConnectAuthenticationNotifications</span><br><span class="line">                &#123;</span><br><span class="line">                    AuthorizationCodeReceived = <span class="keyword">async</span> n =&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">var</span> tokenClient = <span class="keyword">new</span> TokenClient(oathAuthority + <span class="string">"/oauth2/v1/token"</span>, <span class="string">"myclientid123"</span>, <span class="string">"myclientsecret"</span>, AuthenticationStyle.BasicAuthentication);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">var</span> tokenResponse = <span class="keyword">await</span> tokenClient.RequestAuthorizationCodeAsync(n.Code, n.RedirectUri);</span><br><span class="line">                        <span class="keyword">if</span> (tokenResponse.IsError)</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(tokenResponse.Error);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">var</span> userInfoClient = <span class="keyword">new</span> UserInfoClient(oathAuthority + Constants.UserInfoEndpoint);</span><br><span class="line">                        <span class="keyword">var</span> userInfoResponse = <span class="keyword">await</span> userInfoClient.GetAsync(tokenResponse.AccessToken);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">var</span> id = <span class="keyword">new</span> ClaimsIdentity(userInfoResponse.Claims, n.AuthenticationTicket.Identity.AuthenticationType);</span><br><span class="line">                        <span class="keyword">var</span> idClaims = userInfoResponse.Claims;</span><br><span class="line"></span><br><span class="line">                        id.AddClaim(<span class="keyword">new</span> Claim(<span class="string">"id_token"</span>, n.ProtocolMessage.IdToken));</span><br><span class="line">                        id.AddClaim(<span class="keyword">new</span> Claim(<span class="string">"access_token"</span>, tokenResponse.AccessToken));</span><br><span class="line">                        <span class="keyword">if</span> (tokenResponse.RefreshToken != <span class="literal">null</span>)</span><br><span class="line">                            id.AddClaim(<span class="keyword">new</span> Claim(<span class="string">"refresh_token"</span>, tokenResponse.RefreshToken));</span><br><span class="line"></span><br><span class="line">                        id.AddClaim(<span class="keyword">new</span> Claim(<span class="string">"expires_at"</span>, DateTime.Now.AddSeconds(tokenResponse.ExpiresIn).ToLocalTime().ToString(CultureInfo.InvariantCulture)));</span><br><span class="line">                        <span class="keyword">if</span> (tokenResponse.RefreshToken != <span class="literal">null</span>)</span><br><span class="line">                            id.AddClaim(<span class="keyword">new</span> Claim(<span class="string">"refresh_token"</span>, tokenResponse.RefreshToken));</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">var</span> nameClaim = <span class="keyword">new</span> Claim(ClaimTypes.Name, idClaims.FirstOrDefault(c =&gt; c.Type == <span class="string">"name"</span>)?.Value);</span><br><span class="line">                        id.AddClaim(nameClaim);</span><br><span class="line"></span><br><span class="line">                        n.AuthenticationTicket = <span class="keyword">new</span> AuthenticationTicket(<span class="keyword">new</span> ClaimsIdentity(id.Claims, n.AuthenticationTicket.Identity.AuthenticationType),</span><br><span class="line">                            n.AuthenticationTicket.Properties);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//log user in to sitecore</span></span><br><span class="line">                        <span class="keyword">var</span> princ = <span class="keyword">new</span> ClaimsPrincipal(<span class="keyword">new</span>[] &#123; id &#125;);</span><br><span class="line">                        MySite.Helpers.LogUser(princ);</span><br><span class="line">                    &#125;,</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>See below for <code>MySite.Helpers.LogUser(princ)</code> implementation.</p>
<h2 id="Sitecore-login-helper"><a href="#Sitecore-login-helper" class="headerlink" title="Sitecore login helper"></a>Sitecore login helper</h2><p>This helper extracts the required information from Okta’s token response, logs in the user as a <a href="https://briancaos.wordpress.com/2015/11/13/sitecore-virtual-users-authenticate-users-from-external-systems/" target="_blank" rel="noopener">virtual user</a> and maps okta groups to sitecore roles.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Security.Claims;</span><br><span class="line"><span class="keyword">using</span> System.Security.Principal;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNet.Identity;</span><br><span class="line"><span class="keyword">using</span> Sitecore;</span><br><span class="line"><span class="keyword">using</span> Sitecore.Diagnostics;</span><br><span class="line"><span class="keyword">using</span> Sitecore.Security.Accounts;</span><br><span class="line"><span class="keyword">using</span> Sitecore.Security.Authentication;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MySite</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Helpers</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LogUser</span>(<span class="params">IPrincipal principal</span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> identity = principal.Identity <span class="keyword">as</span> ClaimsIdentity;</span><br><span class="line">            <span class="keyword">if</span> (identity == <span class="literal">null</span> || !identity.IsAuthenticated)</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> email = identity.FindFirstValue(<span class="string">"email"</span>);</span><br><span class="line">            <span class="keyword">var</span> userName = identity.FindFirstValue(<span class="string">"preferred_username"</span>);</span><br><span class="line">            <span class="keyword">var</span> sitecoreUsername = <span class="keyword">string</span>.Format(<span class="string">"&#123;0&#125;\\&#123;1&#125;"</span>, <span class="string">"sitecore"</span>, userName);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> user = AuthenticationManager.BuildVirtualUser(sitecoreUsername, <span class="literal">true</span>);</span><br><span class="line">            user.Profile.Name = identity.FindFirstValue(<span class="string">"given_name"</span>);</span><br><span class="line">            user.Profile.Email = email;</span><br><span class="line">            user.Profile.FullName = identity.FindFirstValue(<span class="string">"given_name"</span>);</span><br><span class="line"></span><br><span class="line">            AddRoles(identity, user);</span><br><span class="line">            user.Profile.Save();</span><br><span class="line">            AuthenticationManager.LoginVirtualUser(user);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">AddRoles</span>(<span class="params">ClaimsIdentity claimsIdentity, User user</span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> groups = claimsIdentity.FindAll(<span class="string">"groups"</span>);</span><br><span class="line">            <span class="keyword">if</span> (groups == <span class="literal">null</span> || !groups.Any())</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> <span class="keyword">group</span> <span class="keyword">in</span> groups)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">group</span>.Value.ToLowerInvariant().Equals(<span class="string">"everyone"</span>))</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">var</span> role = <span class="keyword">string</span>.Format(<span class="string">"&#123;0&#125;\\&#123;1&#125;"</span>, <span class="string">"mydomain"</span>, role.Value);</span><br><span class="line">                <span class="keyword">if</span> (Role.Exists(role))</span><br><span class="line">                    user.Roles.Add(Role.FromName(role));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Login-controller"><a href="#Login-controller" class="headerlink" title="Login controller"></a>Login controller</h2><p>All we have left to do now is create a method with the <code>[Authorize]</code> attribute on it, and redirect users to this route so OWIN middleware can take over.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">OktaController</span> : <span class="title">Controller</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ActionResult <span class="title">Callback</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Redirect(<span class="string">"/sitecore"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">Authorize</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ActionResult <span class="title">Login</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> owinContext = System.Web.HttpContext.Current.Request.GetOwinContext();</span><br><span class="line">        <span class="keyword">if</span> (owinContext?.Authentication.User != <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> Redirect(<span class="string">"/sitecore"</span>);</span><br><span class="line">        <span class="keyword">return</span> Redirect(<span class="string">"/"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Do not forget to register the controller’s route in route table.</p>
<p>====================<br><a name="all-authorize">All authorize decorated methods?</a>We didn’t need membership for end users so we could afford to intercept any <code>Authorize</code> attribute. You can configure a separate middleware for end users. See <a href="https://github.com/BasLijten/SitecoreFederatedLogin" target="_blank" rel="noopener">Bas Lijten’s federated solution</a></p>
<p><a name="custom-url">Why a custom url?</a> We opted to use a custom URL because we wanted to be able to log-in to sitecore using the conventional method as well.</p>
<p><a name="versions">Versions used:</a> I had lot of issues figuring out dll versions, so here’s the list of the versions used on this implementation.<br>Newtonsoft.Json 10.0.0.0<br>Microsoft.IdentityModel.Protocol.Extensions 1.0.40306.1554<br>System.IdentityModel.Tokens.Jwt 4.0.40306.1554<br>Microsoft.Owin.Security 3.1.0.0<br>Microsoft.Owin.Security.Cookies 3.1.0.0<br>Microsoft.Owin 3.1.0.0</p>
<p>See <a href="/2017/08/binding-redirect-patch/">this</a> if you are having binding redirects issues.</p>
<p><a name="ticket-function">Create ticket</a> Extracted from: <a href="https://singh-prabhat.blogspot.com/2016/12/sitecore-enable-preview-mode-for.html" target="_blank" rel="noopener">https://singh-prabhat.blogspot.com/2016/12/sitecore-enable-preview-mode-for.html</a><br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">PerformAutoLogin</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">string</span> userName = <span class="string">"extranet\\Preview Anonymous User"</span>;</span><br><span class="line">    AuthenticationManager.Login(userName);</span><br><span class="line">    <span class="keyword">string</span> ticket = Sitecore.Web.Authentication.TicketManager.CreateTicket(userName, <span class="string">@"/sitecore/shell"</span>);</span><br><span class="line">    HttpContext current = HttpContext.Current;</span><br><span class="line">    <span class="keyword">if</span> (current != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        HttpCookie cookie = <span class="keyword">new</span> HttpCookie(Sitecore.Web.Authentication.TicketManager.CookieName, ticket)</span><br><span class="line">        &#123;</span><br><span class="line">            HttpOnly = <span class="literal">true</span></span><br><span class="line">        &#125;;</span><br><span class="line">        current.Response.AppendCookie(cookie);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<hr>
<p>Please let me know what you think and/or if you can spot any errors.<br><em>/eom</em></p>

        </div>
        <footer class="article-footer">
            



    <a data-url="https://josedbaez.com/2017/09/sitecore-okta-login/" data-id="ck2bnqr05001adppbwa67qk29" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>



                        </div>
                    </section>
                    
                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <!--
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                -->
                <p>&copy; 2019 José Domínguez</p>
                <p>Opinions expressed on this blog are my own, and not necessarily those of my employer.</p>
            </div>
            <div class="footer-plugins">
              
    


            </div>
        </div>
    </div>
</footer>

        
    
    <script>
    var disqus_shortname = 'josedbaez';
    
    
    var disqus_url = 'https://josedbaez.com/2017/09/sitecore-okta-login/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>
